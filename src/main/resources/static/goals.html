<!DOCTYPE html>
<html class="dark" lang="ja">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>FutureFlow - 目標設定</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .modal { backdrop-filter: blur(5px); }
    </style>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#258cf4",
                        "background-dark": "#101922",
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-[#101922] text-[#E0E0E0]">
<div class="flex min-h-screen">
    <aside class="flex w-64 flex-col border-r border-white/10 bg-[#111418] p-4">
        <div class="flex items-center gap-3 p-2">
            <span class="material-symbols-outlined text-3xl text-primary">account_balance_wallet</span>
            <span class="font-display text-xl font-bold tracking-tight text-white">FutureFlow</span>
        </div>
        <nav class="mt-8 flex flex-1 flex-col gap-2">
            <a href="index.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-white/5 hover:text-white">
                <span class="material-symbols-outlined">dashboard</span>
                <span class="font-medium">ダッシュボード</span>
            </a>
            
            <a href="categories.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-white/5 hover:text-white">
                <span class="material-symbols-outlined">category</span>
                <span class="font-medium">カテゴリ管理</span>
            </a>
            
            <a href="budgets.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-white/5 hover:text-white">
                <span class="material-symbols-outlined">savings</span>
                <span class="font-medium">予算管理</span>
            </a>
            
            <a href="goals.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-white/5 hover:text-white">
                <span class="material-symbols-outlined">flag</span>
                <span class="font-medium">目標設定</span>
            </a>
            
            <a href="portfolio.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-white/5 hover:text-white">
                <span class="material-symbols-outlined">show_chart</span>
                <span class="font-medium">ポートフォリオ</span>
            </a>
        </nav>
        <div class="mt-auto border-t border-white/10 pt-4">
            <a href="login.html" onclick="logout()" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-red-500/10 hover:text-red-400">
                <span class="material-symbols-outlined">logout</span>
                <span class="font-medium">ログアウト</span>
            </a>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-[#101922] p-8">
        <header class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="font-display text-3xl font-bold text-white">目標設定</h1>
                <p class="mt-1 text-gray-400">将来の夢や購入計画を管理しましょう</p>
            </div>
            <button onclick="openModal()" class="flex items-center gap-2 rounded-lg bg-primary px-4 py-2 font-medium text-white shadow-lg shadow-primary/20 transition-all hover:bg-primary/90 hover:shadow-primary/30">
                <span class="material-symbols-outlined">add</span>
                新しい目標
            </button>
        </header>

        <div id="goals-grid" class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
            <p class="col-span-full text-center text-gray-500">読み込み中...</p>
        </div>
    </main>
</div>

<div id="modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/50 opacity-0 transition-opacity duration-300">
    <div class="w-full max-w-md scale-95 transform rounded-2xl border border-white/10 bg-[#1a2333] p-8 shadow-2xl transition-transform duration-300">
        <h2 class="mb-6 text-2xl font-bold text-white">新しい目標を作成</h2>
        <form id="goal-form" class="space-y-4">
            <div>
                <label class="mb-1 block text-sm font-medium text-gray-400">目標名</label>
                <input type="text" id="name" required placeholder="例: 海外旅行、新車購入" class="w-full rounded-lg border-white/10 bg-[#101922] text-white focus:border-primary focus:ring-primary">
            </div>
            <div>
                <label class="mb-1 block text-sm font-medium text-gray-400">目標金額</label>
                <input type="number" id="targetAmount" required placeholder="100000" class="w-full rounded-lg border-white/10 bg-[#101922] text-white focus:border-primary focus:ring-primary">
            </div>
            <div>
                <label class="mb-1 block text-sm font-medium text-gray-400">現在の貯蓄額 (初期値)</label>
                <input type="number" id="currentAmount" required placeholder="0" class="w-full rounded-lg border-white/10 bg-[#101922] text-white focus:border-primary focus:ring-primary">
                <p class="mt-1 text-xs text-gray-500">※この目標のために既に準備できている金額があれば入力してください</p>
            </div>
            <div>
                <label class="mb-1 block text-sm font-medium text-gray-400">達成予定日</label>
                <input type="date" id="targetDate" required class="w-full rounded-lg border-white/10 bg-[#101922] text-white focus:border-primary focus:ring-primary">
            </div>
            
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="closeModal()" class="rounded-lg px-4 py-2 text-gray-400 hover:bg-white/5 hover:text-white">キャンセル</button>
                <button type="submit" class="rounded-lg bg-primary px-6 py-2 font-medium text-white hover:bg-primary/90">保存</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', fetchGoals);

    // モーダルを開くときに総資産を計算して入力する
    async function openModal() {
        // モーダル表示処理
        const modal = document.getElementById('modal');
        const modalContent = modal.querySelector('div');
        
        // 1. 日付の初期値を今日に
        document.getElementById('targetDate').valueAsDate = new Date();

        // 2. 総資産の自動計算と入力
        try {
            // 現金の取得 (取引履歴から計算)
            const txResponse = await fetch('/api/transactions?limit=10000'); // 全取引取得
            const transactions = await txResponse.json();
            const currentCash = transactions.reduce((sum, t) => sum + (t.type === 'INCOME' ? t.amount : -t.amount), 0);

            // 投資資産の取得
            const assetResponse = await fetch('/api/portfolio/assets');
            const assets = await assetResponse.json();
            const portfolioValue = assets.reduce((sum, a) => sum + a.currentValue, 0);

            // 合計して入力欄にセット (小数点以下切り捨て)
            const totalAssets = Math.floor(currentCash + portfolioValue);
            document.getElementById('currentAmount').value = totalAssets;

        } catch (error) {
            console.error("資産情報の取得に失敗しました:", error);
            document.getElementById('currentAmount').value = 0;
        }

        // アニメーション
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }, 10);
    }

    function closeModal() {
        const modal = document.getElementById('modal');
        const modalContent = modal.querySelector('div');
        modal.classList.add('opacity-0');
        modalContent.classList.remove('scale-100');
        modalContent.classList.add('scale-95');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    // 目標一覧の取得と表示
    async function fetchGoals() {
        try {
            const response = await fetch('/api/goals');
            if (!response.ok) throw new Error("API Error");
            const goals = await response.json();
            
            const container = document.getElementById('goals-grid');
            container.innerHTML = '';

            if (goals.length === 0) {
                container.innerHTML = `<div class="col-span-full py-10 text-center text-gray-500">まだ目標が設定されていません。<br>「新しい目標」ボタンから追加してください。</div>`;
                return;
            }

            goals.forEach(goal => {
                const percentage = goal.targetAmount > 0 
                    ? Math.min(100, (goal.currentAmount / goal.targetAmount) * 100).toFixed(1) 
                    : 0;
                
                const card = document.createElement('div');
                card.className = "rounded-xl border border-white/5 bg-[#1a2333] p-6 shadow-xl transition-transform hover:-translate-y-1";
                card.innerHTML = `
                    <div class="mb-4 flex items-start justify-between">
                        <div class="flex items-center gap-3">
                            <div class="flex h-12 w-12 items-center justify-center rounded-lg bg-primary/20 text-primary">
                                <span class="material-symbols-outlined">flag</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-white">${goal.name}</h3>
                                <p class="text-xs text-gray-400">期限: ${goal.targetDate || '未設定'}</p>
                            </div>
                        </div>
                        <button onclick="deleteGoal(${goal.id})" class="text-gray-500 hover:text-red-400">
                            <span class="material-symbols-outlined text-sm">delete</span>
                        </button>
                    </div>
                    
                    <div class="mb-2 flex items-end justify-between">
                        <span class="text-2xl font-bold text-white">¥${goal.currentAmount.toLocaleString()}</span>
                        <span class="text-sm text-gray-400">/ ¥${goal.targetAmount.toLocaleString()}</span>
                    </div>
                    
                    <div class="relative h-2 w-full overflow-hidden rounded-full bg-gray-700">
                        <div class="absolute left-0 top-0 h-full bg-primary transition-all duration-500" style="width: ${percentage}%"></div>
                    </div>
                    <div class="mt-2 text-right text-xs text-primary">${percentage}% 達成</div>
                `;
                container.appendChild(card);
            });
        } catch (error) {
            console.error("Goals fetch error:", error);
        }
    }

    async function deleteGoal(id) {
        if(!confirm("本当にこの目標を削除しますか？")) return;
        try {
            await fetch(`/api/goals/${id}`, { method: 'DELETE' });
            fetchGoals();
        } catch(e) { console.error(e); }
    }

    document.getElementById('goal-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            name: document.getElementById('name').value,
            targetAmount: document.getElementById('targetAmount').value,
            currentAmount: document.getElementById('currentAmount').value,
            targetDate: document.getElementById('targetDate').value,
            imageUrl: ""
        };
        try {
            const response = await fetch('/api/goals', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (response.ok) {
                closeModal();
                e.target.reset();
                fetchGoals();
            } else {
                alert("登録エラーが発生しました");
            }
        } catch (error) { console.error(error); }
    });

    function logout() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/logout';
        document.body.appendChild(form);
        form.submit();
    }
</script>
</body>
</html>


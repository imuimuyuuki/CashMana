<!DOCTYPE html>
<html class="dark" lang="ja">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>FutureFlow ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .modal { backdrop-filter: blur(5px); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#258cf4",
                        "background-dark": "#101922",
                        "accent-buy": "#34d399",
                        "accent-sell": "#f87171",
                        "accent-stay": "#fbbf24"
                    },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                }
            }
        }
        Chart.defaults.color = '#9ca3af';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
    </script>
</head>
<body class="bg-[#101922] text-[#E0E0E0]">
<div class="flex min-h-screen">
    <aside class="flex w-64 flex-col border-r border-white/10 bg-[#111418] p-4">
        <div class="flex items-center gap-3 p-2">
            <span class="material-symbols-outlined text-3xl text-primary">account_balance_wallet</span>
            <span class="font-display text-xl font-bold tracking-tight text-white">FutureFlow</span>
        </div>
        <nav class="mt-8 flex flex-1 flex-col gap-2">
            <a href="index.html" class="flex items-center gap-3 rounded-lg bg-primary/10 px-4 py-3 text-primary transition-colors hover:bg-primary/20">
                <span class="material-symbols-outlined">dashboard</span>
                <span class="font-medium">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
            </a>
            <a href="categories.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-white/5 hover:text-white">
                <span class="material-symbols-outlined">category</span>
                <span class="font-medium">ã‚«ãƒ†ã‚´ãƒªç®¡ç†</span>
            </a>
            <a href="budgets.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-white/5 hover:text-white">
                <span class="material-symbols-outlined">savings</span>
                <span class="font-medium">äºˆç®—ç®¡ç†</span>
            </a>
            <a href="goals.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-white/5 hover:text-white">
                <span class="material-symbols-outlined">flag</span>
                <span class="font-medium">ç›®æ¨™è¨­å®š</span>
            </a>
            <a href="portfolio.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-white/5 hover:text-white">
                <span class="material-symbols-outlined">show_chart</span>
                <span class="font-medium">ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª</span>
            </a>
        </nav>
        <div class="mt-auto border-t border-white/10 pt-4">
            <a href="#" onclick="logout()" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-red-500/10 hover:text-red-400">
                <span class="material-symbols-outlined">logout</span>
                <span class="font-medium">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
            </a>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-[#101922] p-8">
        <header class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="font-display text-3xl font-bold text-white">è³‡ç”£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                <p class="mt-1 text-gray-400">ç¾åœ¨ã®è²¡å‹™çŠ¶æ³ã¨äºˆæ¸¬åˆ†æ</p>
            </div>
            <button onclick="openModal()" class="flex items-center gap-2 rounded-lg bg-primary px-4 py-2 font-medium text-white shadow-lg shadow-primary/20 transition-all hover:bg-primary/90 hover:shadow-primary/30">
                <span class="material-symbols-outlined">add</span>
                å–å¼•ã‚’è¿½åŠ 
            </button>
        </header>

        <div class="mb-8 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
            <div class="rounded-xl border border-white/5 bg-[#1a2333] p-6 shadow-xl">
                <p class="text-sm font-medium text-gray-400">ç·è³‡ç”£</p>
                <p id="total-assets" class="mt-2 text-3xl font-bold text-white">Â¥0</p>
                <div class="mt-2 flex items-center text-sm text-green-400">
                    <span class="material-symbols-outlined mr-1 text-base">trending_up</span>
                    <span>ç¾åœ¨ã®çŠ¶æ³</span>
                </div>
            </div>
            <div class="rounded-xl border border-white/5 bg-[#1a2333] p-6 shadow-xl">
                <p class="text-sm font-medium text-gray-400">ä»Šæœˆã®åå…¥</p>
                <p id="monthly-income" class="mt-2 text-3xl font-bold text-white">Â¥0</p>
            </div>
            <div class="rounded-xl border border-white/5 bg-[#1a2333] p-6 shadow-xl">
                <p class="text-sm font-medium text-gray-400">ä»Šæœˆã®æ”¯å‡º</p>
                <p id="monthly-expense" class="mt-2 text-3xl font-bold text-white">Â¥0</p>
            </div>
            <div class="rounded-xl border border-white/5 bg-[#1a2333] p-6 shadow-xl">
                <p class="text-sm font-medium text-gray-400">è²¯è“„ç‡</p>
                <p id="savings-rate" class="mt-2 text-3xl font-bold text-white">0%</p>
            </div>
        </div>

        <div class="mb-8 grid grid-cols-1 gap-8 lg:grid-cols-3">
            <div class="col-span-2 rounded-xl border border-white/5 bg-[#1a2333] p-6 shadow-xl">
                <h3 class="mb-6 text-lg font-bold text-white">è³‡ç”£æ¨ç§» (éå»6ãƒ¶æœˆ)</h3>
                <div class="h-[300px]">
                    <canvas id="balanceChart"></canvas>
                </div>
            </div>
            
            <div class="rounded-xl border border-white/5 bg-[#1a2333] p-6 shadow-xl">
                <div class="mb-6 flex items-center justify-between">
                    <h3 class="text-lg font-bold text-white">æ”¯å‡ºå†…è¨³</h3>
                    <select id="pie-chart-period" class="rounded-lg border-white/10 bg-[#101922] text-sm text-gray-300 focus:border-primary focus:ring-primary">
                        <option value="this_month">ä»Šæœˆ</option>
                        <option value="last_month">å…ˆæœˆ</option>
                    </select>
                </div>
                <div class="relative flex h-[300px] items-center justify-center">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>

        <div class="mb-8 rounded-xl border border-white/5 bg-[#1a2333] p-6 shadow-xl">
            <h3 class="mb-4 text-lg font-bold text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">receipt_long</span>
                æœ€è¿‘ã®å–å¼•å±¥æ­´
            </h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm text-gray-400">
                    <thead class="border-b border-white/10 bg-white/5 text-xs uppercase text-gray-400">
                        <tr>
                            <th class="px-6 py-3">æ—¥ä»˜</th>
                            <th class="px-6 py-3">ã‚«ãƒ†ã‚´ãƒª</th>
                            <th class="px-6 py-3">å†…å®¹</th>
                            <th class="px-6 py-3 text-right">é‡‘é¡</th>
                            <th class="px-6 py-3 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-list-body" class="divide-y divide-white/5">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="mb-8 rounded-xl border border-white/5 bg-[#1a2333] p-6 shadow-xl">
            <h3 class="mb-4 text-lg font-bold text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">timeline</span>
                AIè³‡ç”£äºˆæ¸¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            </h3>
            
            <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
                <div class="lg:col-span-2">
                    <div class="h-[300px] w-full">
                        <canvas id="predictionChart"></canvas>
                    </div>
                </div>

                <div class="lg:col-span-1 flex flex-col justify-center rounded-xl bg-[#111822] p-6 border border-white/5">
                    <div class="mb-4">
                        <span class="text-xs font-bold uppercase tracking-wider text-gray-500">AIè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ</span>
                        <div class="mt-2 flex items-center gap-2">
                            <span class="material-symbols-outlined text-3xl text-primary">analytics</span>
                            <span class="text-xl font-bold text-white">å°†æ¥ã®è¦‹é€šã—</span>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <p id="prediction-feedback-main" class="text-base font-medium text-white leading-relaxed">
                            ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...
                        </p>
                    </div>

                    <div class="rounded-lg bg-primary/10 p-4 border border-primary/20">
                        <div class="flex items-start gap-3">
                            <span class="material-symbols-outlined text-primary mt-0.5">lightbulb</span>
                            <div>
                                <p class="text-sm font-bold text-primary mb-1">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ææ¡ˆ</p>
                                <p id="prediction-advice" class="text-sm text-gray-300">
                                    æ¯æœˆã®åæ”¯ãƒãƒ©ãƒ³ã‚¹ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="border-t border-white/10 pt-8 mt-8">
            <h2 class="mb-6 text-2xl font-bold text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">currency_exchange</span>
                <span class="flex items-center gap-2">
                    AI FX / å¤–è²¨é‹ç”¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    <span class="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded-full animate-pulse">LIVE</span>
                </span>
            </h2>

            <div class="mb-8 rounded-xl bg-gradient-to-r from-[#1a2333] to-[#111822] p-6 border border-white/10 shadow-lg">
                <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">info</span>
                    ã“ã®æ©Ÿèƒ½ã«ã¤ã„ã¦ï¼ˆAIåˆ†æã®ä»•çµ„ã¿ï¼‰
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm text-gray-300 leading-relaxed">
                    <div>
                        <p class="font-bold text-gray-100 mb-1">ğŸ“Š ã©ã‚“ãªãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ï¼Ÿ</p>
                        <p class="mb-3">
                            å®Ÿéš›ã®å¸‚å ´ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆï¼ˆUSD/JPYï¼‰ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å–å¾—ã—ã€çŸ­æœŸãƒ»ä¸­æœŸã®ç§»å‹•å¹³å‡ç·šã€ãŠã‚ˆã³ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆå¤‰å‹•ç‡ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã„ã¾ã™ã€‚
                        </p>
                        <p class="font-bold text-gray-100 mb-1">ğŸ¤– ã©ã®AIã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ï¼Ÿ</p>
                        <p>
                            ç‹¬è‡ªã®<span class="text-primary font-bold">ã€Œæ™‚ç³»åˆ—ãƒˆãƒ¬ãƒ³ãƒ‰è§£æã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€</span>ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚éå»ã®ãƒãƒ£ãƒ¼ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰å°†æ¥ã®ä¾¡æ ¼å¤‰å‹•ç¢ºç‡ã‚’çµ±è¨ˆçš„ã«ç®—å‡ºã—ã¾ã™ã€‚
                        </p>
                    </div>
                    <div>
                        <p class="font-bold text-gray-100 mb-1">ğŸ’¡ ãªãœã“ã®åˆ¤æ–­ã«ãªã‚‹ã®ï¼Ÿ</p>
                        <p>
                            ç¾åœ¨ã®ãƒ¬ãƒ¼ãƒˆãŒãƒˆãƒ¬ãƒ³ãƒ‰ã‹ã‚‰ã©ã‚Œãã‚‰ã„ä¹–é›¢ã—ã¦ã„ã‚‹ã‹ï¼ˆè²·ã‚ã‚Œã™ããƒ»å£²ã‚‰ã‚Œã™ãï¼‰ã‚’è¨ˆç®—ã—ã€åç™ºã™ã‚‹ã‹ãƒˆãƒ¬ãƒ³ãƒ‰ãŒç¶™ç¶šã™ã‚‹ã‹ã‚’åˆ¤å®šã—ã¦ã„ã¾ã™ã€‚
                        </p>
                        <ul class="mt-2 space-y-1 list-disc list-inside text-gray-400">
                            <li><span class="text-accent-buy font-bold">BUY</span>: å£²ã‚‰ã‚Œã™ãã‚¾ãƒ¼ãƒ³ã€‚åç™ºä¸Šæ˜‡ã®å¯èƒ½æ€§ãŒé«˜ã„ã€‚</li>
                            <li><span class="text-accent-sell font-bold">SELL</span>: è²·ã‚ã‚Œã™ãã‚¾ãƒ¼ãƒ³ã€‚ä¸‹è½èª¿æ•´ã®ãƒªã‚¹ã‚¯ãŒé«˜ã„ã€‚</li>
                            <li><span class="text-accent-stay font-bold">STAY</span>: æ–¹å‘æ„ŸãŒä¸æ˜ç¢ºã€‚ãƒªã‚¹ã‚¯å›é¿ã‚’æ¨å¥¨ã€‚</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
                <div class="col-span-1 rounded-xl border border-white/5 bg-[#1a2333] p-6 shadow-xl">
                    <h3 class="mb-4 text-lg font-bold text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">psychology</span>
                        AIæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
                    </h3>
                    
                    <div id="ai-loading" class="text-center py-10">
                        <span class="material-symbols-outlined animate-spin text-4xl text-primary">sync</span>
                        <p class="mt-2 text-sm text-gray-400">å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...</p>
                    </div>

                    <div id="ai-result" class="hidden animate-fade-in">
                        <div class="mb-4 text-center">
                            <span id="recommendation-badge" class="inline-block rounded-full px-4 py-1 text-xl font-bold"></span>
                        </div>
                        <div class="mb-6 text-center">
                            <p class="text-sm text-gray-400">ç¾åœ¨ãƒ¬ãƒ¼ãƒˆ (USD/JPY)</p>
                            <p id="current-rate" class="text-4xl font-bold text-white transition-all duration-300">---.--</p>
                        </div>
                        <div class="mb-4 rounded-lg bg-[#101922] p-4">
                            <p class="text-xs font-bold text-gray-500 mb-1">AIã®åˆ†ææ ¹æ‹ :</p>
                            <p id="ai-reason" class="text-sm text-gray-300 leading-relaxed"></p>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-400">
                            <span>äºˆæ¸¬ãƒªã‚¹ã‚¯å¤‰å‹•å¹…:</span>
                            <span id="risk-percentage" class="font-bold text-red-400"></span>
                        </div>
                    </div>
                </div>

                <div class="col-span-1 lg:col-span-2 rounded-xl border border-white/5 bg-[#1a2333] p-6 shadow-xl">
                    <h3 class="mb-4 text-lg font-bold text-white">ãƒˆãƒ¬ãƒ³ãƒ‰äºˆæ¸¬ãƒãƒ£ãƒ¼ãƒˆ (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°)</h3>
                    <div class="relative h-[300px] w-full">
                        <canvas id="fxChart"></canvas>
                    </div>
                </div>

                <div class="col-span-1 lg:col-span-3 rounded-xl border border-white/5 bg-[#1a2333] p-6 shadow-xl">
                    <h3 class="mb-4 text-lg font-bold text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-green-400">calculate</span>
                        ãƒ‰ãƒ«è³‡ç”£é‹ç”¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    </h3>
                    <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-400">æŠ•è³‡é‡‘é¡ (å††)</label>
                            <div class="flex gap-2">
                                <input type="number" id="invest-amount" value="100000" class="w-full rounded-lg border-white/10 bg-[#101922] text-white focus:border-primary focus:ring-primary">
                                <button onclick="calculateFXSimulation()" class="rounded-lg bg-primary px-6 py-2 font-medium text-white hover:bg-primary/90">è©¦ç®—</button>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">â€»ç¾åœ¨ã®ãƒ¬ãƒ¼ãƒˆã§ãƒ‰ãƒ«ã‚’è³¼å…¥ã—ã€1é€±é–“å¾Œã«æ±ºæ¸ˆã—ãŸå ´åˆã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</p>
                        </div>
                        <div class="flex items-center justify-around rounded-lg bg-[#101922] p-4">
                            <div class="text-center">
                                <p class="text-xs text-gray-400">äºˆæƒ³è©•ä¾¡é¡</p>
                                <p id="sim-result-amount" class="text-2xl font-bold text-white">---</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-400">äºˆæƒ³æç›Š</p>
                                <p id="sim-result-profit" class="text-2xl font-bold text-gray-500">---</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<div id="modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/50 opacity-0 transition-opacity duration-300">
    <div class="w-full max-w-md scale-95 transform rounded-2xl border border-white/10 bg-[#1a2333] p-8 shadow-2xl transition-transform duration-300">
        <h2 id="modal-title" class="mb-6 text-2xl font-bold text-white">å–å¼•ã‚’è¿½åŠ </h2>
        <form id="transaction-form" class="space-y-4">
            <input type="hidden" id="edit-id" value="">
            
            <div>
                <label class="mb-1 block text-sm font-medium text-gray-400">æ—¥ä»˜</label>
                <input type="date" id="date" required class="w-full rounded-lg border-white/10 bg-[#101922] text-white focus:border-primary focus:ring-primary">
            </div>
            <div>
                <label class="mb-1 block text-sm font-medium text-gray-400">é‡‘é¡</label>
                <input type="number" id="amount" required class="w-full rounded-lg border-white/10 bg-[#101922] text-white focus:border-primary focus:ring-primary">
            </div>
            <div>
                <label class="mb-1 block text-sm font-medium text-gray-400">ã‚¿ã‚¤ãƒ—</label>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2">
                        <input type="radio" name="type" value="INCOME" class="text-primary focus:ring-primary" onclick="handleTypeChange('INCOME')">
                        <span class="text-white">åå…¥</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="radio" name="type" value="EXPENSE" checked class="text-primary focus:ring-primary" onclick="handleTypeChange('EXPENSE')">
                        <span class="text-white">æ”¯å‡º</span>
                    </label>
                </div>
            </div>
            <div>
                <label class="mb-1 block text-sm font-medium text-gray-400">ã‚«ãƒ†ã‚´ãƒª</label>
                <select id="category" required class="w-full rounded-lg border-white/10 bg-[#101922] text-white focus:border-primary focus:ring-primary">
                </select>
            </div>
            
            <div>
                <label class="mb-1 block text-sm font-medium text-gray-400">ç›®æ¨™ã¸ã®è²¯é‡‘ï¼ˆä»»æ„ï¼‰</label>
                <select id="goal-select" class="w-full rounded-lg border-white/10 bg-[#101922] text-white focus:border-primary focus:ring-primary disabled:bg-gray-800 disabled:text-gray-500 disabled:cursor-not-allowed">
                    <option value="">-- ç›®æ¨™ã‚’é¸æŠã—ãªã„ --</option>
                </select>
                <p id="goal-help" class="text-xs text-gray-500 mt-1 hidden">â€»ç›®æ¨™ã¸ã®ç´ä»˜ã‘ã¯ã€Œåå…¥ã€æ™‚ã®ã¿å¯èƒ½ã§ã™</p>
            </div>

            <div class="flex items-center gap-2">
                <input type="checkbox" id="isExtraordinary" class="rounded border-white/10 bg-[#101922] text-primary focus:ring-primary">
                <label for="isExtraordinary" class="text-sm text-gray-400">è‡¨æ™‚åæ”¯ï¼ˆäºˆæ¸¬ã‹ã‚‰é™¤å¤–ï¼‰</label>
            </div>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="closeModal()" class="rounded-lg px-4 py-2 text-gray-400 hover:bg-white/5 hover:text-white">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="submit" class="rounded-lg bg-primary px-6 py-2 font-medium text-white hover:bg-primary/90">ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<script>
    let barChartInstance = null;
    let pieChartInstance = null;
    let predictionChartInstance = null;
    let fxChartInstance = null; 
    let fxData = null; 
    let fxIntervalId = null;

    document.addEventListener('DOMContentLoaded', () => {
        handleTypeChange('EXPENSE');
        loadGoals();
        updateDashboard();
        updatePrediction();
        setupPieChartListener();
        
        // FXãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹
        fetchFXData();
        fxIntervalId = setInterval(fetchFXData, 3000);
    });

    async function updateDashboard() {
        try {
            const txResponse = await fetch('/api/transactions?limit=100'); 
            const transactions = await txResponse.json();
            renderTransactionList(transactions);

            const now = new Date();
            const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const income = transactions.filter(t => t.type === 'INCOME' && t.date.startsWith(thisMonth)).reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'EXPENSE' && t.date.startsWith(thisMonth)).reduce((sum, t) => sum + t.amount, 0);
            const assetResponse = await fetch('/api/portfolio/assets');
            const assets = await assetResponse.json();
            const portfolioValue = assets.reduce((sum, a) => sum + a.currentValue, 0);
            const totalCash = transactions.reduce((sum, t) => sum + (t.type === 'INCOME' ? t.amount : -t.amount), 0);
            const totalAssets = totalCash + portfolioValue;

            document.getElementById('total-assets').textContent = `Â¥${Math.round(totalAssets).toLocaleString()}`;
            document.getElementById('monthly-income').textContent = `Â¥${Math.round(income).toLocaleString()}`;
            document.getElementById('monthly-expense').textContent = `Â¥${Math.round(expense).toLocaleString()}`;
            const savingsRate = income > 0 ? ((income - expense) / income * 100).toFixed(1) : 0;
            document.getElementById('savings-rate').textContent = `${savingsRate}%`;

            const monthlyResponse = await fetch('/api/transactions/monthly-summary');
            if(monthlyResponse.ok) renderBarChart(await monthlyResponse.json());
            updatePieChartByPeriod('this_month');

        } catch (error) { console.error("Dashboard update error:", error); }
    }

    function renderTransactionList(transactions) {
        const tbody = document.getElementById('transaction-list-body');
        tbody.innerHTML = '';
        transactions.slice(0, 10).forEach(t => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-white/5 transition-colors";
            const isIncome = t.type === 'INCOME';
            const amountClass = isIncome ? 'text-green-400' : 'text-red-400';
            const sign = isIncome ? '+' : '-';
            const desc = t.goalName ? `<span class="text-xs bg-primary/20 text-primary px-2 py-0.5 rounded ml-2">ç›®æ¨™: ${t.goalName}</span>` : '';

            tr.innerHTML = `
                <td class="px-6 py-4">${t.date}</td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-medium ${isIncome ? 'bg-green-400/10 text-green-400' : 'bg-red-400/10 text-red-400'}">
                        ${t.categoryName || 'æœªåˆ†é¡'}
                    </span>
                </td>
                <td class="px-6 py-4 text-white">${desc}</td>
                <td class="px-6 py-4 text-right font-bold ${amountClass}">${sign}Â¥${t.amount.toLocaleString()}</td>
                <td class="px-6 py-4 text-center">
                    <div class="flex items-center justify-center gap-2">
                        <button onclick='openEditModal(${JSON.stringify(t)})' class="text-gray-400 hover:text-primary transition-colors">
                            <span class="material-symbols-outlined text-sm">edit</span>
                        </button>
                        <button onclick="deleteTransaction(${t.id})" class="text-gray-400 hover:text-red-400 transition-colors">
                            <span class="material-symbols-outlined text-sm">delete</span>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderBarChart(data) {
        const ctx = document.getElementById('balanceChart').getContext('2d');
        if (barChartInstance) barChartInstance.destroy();
        barChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.month),
                datasets: [
                    { label: 'åå…¥', data: data.map(d => d.totalIncome), backgroundColor: '#34d399', borderRadius: 4 },
                    { label: 'æ”¯å‡º', data: data.map(d => d.totalExpense), backgroundColor: '#f87171', borderRadius: 4 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#9ca3af' } } }, scales: { y: { grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#9ca3af' } }, x: { display: false } } }
        });
    }

    function setupPieChartListener() {
        document.getElementById('pie-chart-period').addEventListener('change', (e) => updatePieChartByPeriod(e.target.value));
    }
    
    function updatePieChartByPeriod(period) {
        const now = new Date();
        let startDate, endDate;
        if (period === 'this_month') {
            startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
        } else {
            startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().split('T')[0];
            endDate = new Date(now.getFullYear(), now.getMonth(), 0).toISOString().split('T')[0];
        }
        updatePieChart(startDate, endDate);
    }

    async function updatePieChart(startDate, endDate) {
        try {
            const response = await fetch(`/api/transactions/summary?startDate=${startDate}&endDate=${endDate}&type=EXPENSE`);
            if (!response.ok) return;
            const data = await response.json();
            const ctx = document.getElementById('expenseChart').getContext('2d');
            if (pieChartInstance) pieChartInstance.destroy();
            pieChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.categoryName),
                    datasets: [{ data: data.map(d => d.totalAmount), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { color: '#9ca3af' } } } }
            });
        } catch(e) {}
    }

    // â–¼â–¼â–¼ AIè³‡ç”£äºˆæ¸¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (ä»Šå›ã®ä¿®æ­£ç‰ˆ) â–¼â–¼â–¼
    async function updatePrediction() {
        try {
            const predResponse = await fetch('/api/transactions/predict?monthsToPredict=12');
            if (!predResponse.ok) return;
            const predResult = await predResponse.json();

            // éå»6ãƒ¶æœˆã®å®Ÿç¸¾ã‚’å–å¾—ã—ã¦ã€éå»ã®è³‡ç”£æ¨ç§»ã‚’é€†ç®—
            const histResponse = await fetch('/api/transactions/monthly-summary');
            let historyPoints = [];
            let historyLabels = [];
            
            if (histResponse.ok) {
                const monthlyData = await histResponse.json(); 
                let currentBalance = predResult.initialBalance;
                
                historyPoints.unshift(currentBalance);
                historyLabels.unshift("ç¾åœ¨");

                const loopCount = Math.min(monthlyData.length, 6);
                for (let i = 0; i < loopCount; i++) {
                    const m = monthlyData[i];
                    currentBalance = currentBalance - (m.totalIncome - m.totalExpense);
                    historyPoints.unshift(currentBalance);
                    historyLabels.unshift(`${i + 1}ãƒ¶æœˆå‰`);
                }
            }

            // ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢
            const futureLabels = Array.from({length: predResult.projectionPoints.length - 1}, (_, i) => `${i + 1}ãƒ¶æœˆå¾Œ`);
            const futurePointsRaw = predResult.projectionPoints.slice(1);
            const totalLabels = [...historyLabels, ...futureLabels];

            // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ1: å®Ÿç¸¾ (éå»ã€œç¾åœ¨)
            const datasetHistory = [
                ...historyPoints, 
                ...new Array(futurePointsRaw.length).fill(null)
            ];

            // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ2: äºˆæ¸¬ (ç¾åœ¨ã€œæœªæ¥)
            const datasetFuture = [
                ...new Array(historyPoints.length - 1).fill(null),
                historyPoints[historyPoints.length - 1], // ç¾åœ¨åœ°ç‚¹ã‚’ã¤ãªã
                ...futurePointsRaw
            ];

            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ›´æ–°
            document.getElementById('prediction-feedback-main').textContent = predResult.feedback;
            const adviceElement = document.getElementById('prediction-advice');
            if (predResult.shortfallAmount > 0) {
                adviceElement.textContent = `ç›®æ¨™é”æˆã«ã¯ã€æ¯æœˆã‚ã¨ Â¥${Math.round(predResult.shortfallAmount).toLocaleString()} ã®ãƒ—ãƒ©ã‚¹ãŒå¿…è¦ã§ã™ã€‚`;
            } else if (predResult.isAchievable) {
                adviceElement.textContent = "é †èª¿ã§ã™ã€‚ã“ã®ãƒšãƒ¼ã‚¹ãªã‚‰ç›®æ¨™ã‚’é”æˆã§ãã‚‹è¦‹è¾¼ã¿ã§ã™ã€‚";
            } else {
                adviceElement.textContent = "ç¾åœ¨ã®åæ”¯çŠ¶æ³ã§ã¯è³‡ç”£ãŒæ¸›å°‘å‚¾å‘ã§ã™ã€‚å›ºå®šè²»ã®è¦‹ç›´ã—ã‚’æ¨å¥¨ã—ã¾ã™ã€‚";
            }

            // ãƒãƒ£ãƒ¼ãƒˆæç”»
            const ctx = document.getElementById('predictionChart').getContext('2d');
            if (predictionChartInstance) predictionChartInstance.destroy();

            predictionChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: totalLabels,
                    datasets: [
                        {
                            label: 'å®Ÿç¸¾ (éå»6ãƒ¶æœˆ)',
                            data: datasetHistory,
                            borderColor: '#3b82f6', // å®Ÿç¸¾: é’è‰² (å®Ÿç·š)
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            pointRadius: 0,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'AIäºˆæ¸¬ (ä»Šå¾Œ1å¹´)',
                            data: datasetFuture,
                            borderColor: '#ef4444', // äºˆæ¸¬: èµ¤è‰² (ç‚¹ç·š)
                            borderWidth: 3,
                            borderDash: [6, 6], // ç‚¹ç·šåŒ–
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#ef4444',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, labels: { color: '#9ca3af' } },
                        tooltip: {
                            backgroundColor: 'rgba(26, 35, 51, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            callbacks: { label: (c) => ` ${c.dataset.label}: Â¥` + Math.round(c.raw).toLocaleString() }
                        }
                    },
                    scales: {
                        y: { 
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }, 
                            ticks: { 
                                color: '#9ca3af',
                                callback: function(value) {
                                    if (Math.abs(value) >= 100000000) return (value / 100000000).toFixed(1) + 'å„„å††';
                                    if (Math.abs(value) >= 10000) return (value / 10000).toFixed(0) + 'ä¸‡å††';
                                    return value.toLocaleString();
                                }
                            } 
                        },
                        x: { grid: { display: false }, ticks: { color: '#9ca3af', maxTicksLimit: 8 } }
                    }
                }
            });
        } catch (e) { console.error("Prediction chart error:", e); }
    }

    // FXé–¢é€£
    async function fetchFXData() {
        try {
            const response = await fetch('/api/fx/analysis');
            if (!response.ok) throw new Error("API Error");
            fxData = await response.json();
            renderAnalysis(fxData);
            renderFXChart(fxData);
        } catch (error) { console.error("FX Data fetch error:", error); }
    }

    function renderAnalysis(data) {
        document.getElementById('ai-loading').classList.add('hidden');
        document.getElementById('ai-result').classList.remove('hidden');
        document.getElementById('current-rate').textContent = `Â¥${data.currentRate.toFixed(2)}`;
        document.getElementById('ai-reason').textContent = data.reason;
        document.getElementById('risk-percentage').textContent = `Â±${data.riskPercentage.toFixed(1)}%`;
        const badge = document.getElementById('recommendation-badge');
        if (data.recommendation === 'BUY') {
            badge.textContent = 'è²·ã„æ¨å¥¨ (BUY)'; badge.className = 'inline-block rounded-full bg-accent-buy/20 text-accent-buy px-4 py-1 text-xl font-bold';
        } else if (data.recommendation === 'SELL') {
            badge.textContent = 'å£²ã‚Šæ¨å¥¨ (SELL)'; badge.className = 'inline-block rounded-full bg-accent-sell/20 text-accent-sell px-4 py-1 text-xl font-bold';
        } else {
            badge.textContent = 'æ§˜å­è¦‹ (STAY)'; badge.className = 'inline-block rounded-full bg-accent-stay/20 text-accent-stay px-4 py-1 text-xl font-bold';
        }
    }

    function renderFXChart(data) {
        const ctx = document.getElementById('fxChart').getContext('2d');
        if (fxChartInstance) fxChartInstance.destroy();
        const historyLength = data.history.length;
        const totalLabels = Array.from({length: historyLength + data.prediction.length}, (_, i) => i < historyLength ? `${i-historyLength}æ—¥å‰` : `${i-historyLength+1}æ—¥å¾Œ`);
        fxChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: totalLabels,
                datasets: [{
                    label: 'USD/JPY ãƒ¬ãƒ¼ãƒˆ',
                    data: [...data.history, ...data.prediction],
                    borderColor: (ctx) => ctx.p0DataIndex < historyLength - 1 ? '#3b82f6' : '#a855f7',
                    segment: { borderDash: (ctx) => ctx.p0DataIndex >= historyLength - 1 ? [6, 6] : undefined },
                    borderWidth: 2, pointRadius: 0, tension: 0.1
                }]
            },
            options: { animation: { duration: 0 }, responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#9ca3af' } } } }
        });
    }

    function calculateFXSimulation() {
        if (!fxData) return;
        const yenAmount = parseFloat(document.getElementById('invest-amount').value);
        if (isNaN(yenAmount) || yenAmount <= 0) { alert("æœ‰åŠ¹ãªé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
        const dollars = yenAmount / fxData.currentRate;
        const futureYen = dollars * fxData.prediction[fxData.prediction.length - 1];
        const profit = futureYen - yenAmount;
        document.getElementById('sim-result-amount').textContent = `Â¥${Math.round(futureYen).toLocaleString()}`;
        const profitElem = document.getElementById('sim-result-profit');
        profitElem.textContent = `${profit >= 0 ? '+' : ''}Â¥${Math.round(profit).toLocaleString()}`;
        profitElem.className = `text-2xl font-bold ${profit >= 0 ? 'text-green-400' : 'text-red-400'}`;
    }

    // ç·¨é›†ãƒ»å‰Šé™¤
    function openEditModal(tx) {
        document.getElementById('modal-title').textContent = "å–å¼•ã‚’ç·¨é›†";
        document.getElementById('edit-id').value = tx.id;
        document.getElementById('date').value = tx.date;
        document.getElementById('amount').value = tx.amount;
        const typeRadio = document.querySelector(`input[name="type"][value="${tx.type}"]`);
        if(typeRadio) { typeRadio.checked = true; handleTypeChange(tx.type); }
        setTimeout(() => {
            document.getElementById('category').value = tx.categoryId;
            if (tx.goalId) document.getElementById('goal-select').value = tx.goalId;
        }, 100);
        document.getElementById('isExtraordinary').checked = tx.isExtraordinary;
        openModal(true);
    }

    async function deleteTransaction(id) {
        if(!confirm("ã“ã®å–å¼•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        try {
            const res = await fetch(`/api/transactions/${id}`, { method: 'DELETE' });
            if(res.ok) updateDashboard();
        } catch(e) { console.error(e); }
    }

    const modal = document.getElementById('modal');
    function openModal(isEdit = false) {
        if (!isEdit) {
            document.getElementById('modal-title').textContent = "å–å¼•ã‚’è¿½åŠ ";
            document.getElementById('transaction-form').reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('date').valueAsDate = new Date();
            document.querySelector('input[name="type"][value="EXPENSE"]').checked = true;
            handleTypeChange('EXPENSE');
        }
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modal.querySelector('div').classList.add('scale-100');
        }, 10);
    }

    function closeModal() {
        modal.classList.add('opacity-0');
        modal.querySelector('div').classList.remove('scale-100');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    document.getElementById('transaction-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const editId = document.getElementById('edit-id').value;
        const goalSelect = document.getElementById('goal-select');
        const goalId = (!goalSelect.disabled && goalSelect.value) ? parseInt(goalSelect.value) : null;
        const data = {
            date: document.getElementById('date').value,
            amount: document.getElementById('amount').value,
            type: document.querySelector('input[name="type"]:checked').value,
            categoryId: document.getElementById('category').value,
            goalId: goalId, 
            isExtraordinary: document.getElementById('isExtraordinary').checked
        };
        let url = '/api/transactions'; let method = 'POST';
        if (editId) { url = `/api/transactions/${editId}`; method = 'PUT'; }
        await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        closeModal();
        updateDashboard(); updatePrediction(); loadGoals();
    });

    function handleTypeChange(type) {
        loadCategories(type);
        const goalSelect = document.getElementById('goal-select');
        const goalHelp = document.getElementById('goal-help');
        if (type === 'EXPENSE') {
            goalSelect.value = ""; goalSelect.disabled = true; goalHelp.classList.remove('hidden');
        } else {
            goalSelect.disabled = false; goalHelp.classList.add('hidden');
        }
    }
    
    async function loadCategories(type) {
        const response = await fetch('/api/categories');
        const categories = await response.json();
        const select = document.getElementById('category');
        select.innerHTML = '';
        categories.filter(c => c.type === type).forEach(c => {
            const option = document.createElement('option');
            option.value = c.id; option.textContent = c.name; select.appendChild(option);
        });
    }
    
    async function loadGoals() {
        try {
            const response = await fetch('/api/goals');
            if (response.ok) {
                const goals = await response.json();
                const select = document.getElementById('goal-select');
                select.innerHTML = '<option value="">-- ç›®æ¨™ã‚’é¸æŠã—ãªã„ --</option>'; 
                goals.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g.id; option.textContent = g.name; select.appendChild(option);
                });
            }
        } catch (e) {}
    }
    
    function logout() {
        const form = document.createElement('form');
        form.method = 'POST'; form.action = '/logout'; document.body.appendChild(form); form.submit();
    }
</script>
</body>
</html>

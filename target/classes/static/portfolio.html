<!DOCTYPE html>
<html class="dark" lang="ja">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>FutureFlow - ポートフォリオ</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .modal { backdrop-filter: blur(5px); }
    </style>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#258cf4",
                        "background-light": "#f5f7f8",
                        "background-dark": "#101922",
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-[#101922] text-[#E0E0E0]">
<div class="flex min-h-screen">
    <aside class="flex w-64 flex-col border-r border-white/10 bg-[#111418] p-4">
        <div class="flex items-center gap-3 p-2">
            <span class="material-symbols-outlined text-3xl text-primary">account_balance_wallet</span>
            <span class="font-display text-xl font-bold tracking-tight text-white">FutureFlow</span>
        </div>
        <nav class="mt-8 flex flex-1 flex-col gap-2">
            <a href="index.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-white/5 hover:text-white">
                <span class="material-symbols-outlined">dashboard</span>
                <span class="font-medium">ダッシュボード</span>
            </a>
            
            <a href="categories.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-white/5 hover:text-white">
                <span class="material-symbols-outlined">category</span>
                <span class="font-medium">カテゴリ管理</span>
            </a>
            
            <a href="budgets.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-white/5 hover:text-white">
                <span class="material-symbols-outlined">savings</span>
                <span class="font-medium">予算管理</span>
            </a>
            
            <a href="goals.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-white/5 hover:text-white">
                <span class="material-symbols-outlined">flag</span>
                <span class="font-medium">目標設定</span>
            </a>
            
            <a href="portfolio.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-white/5 hover:text-white">
                <span class="material-symbols-outlined">show_chart</span>
                <span class="font-medium">ポートフォリオ</span>
            </a>
        </nav>
        <div class="mt-auto border-t border-white/10 pt-4">
            <a href="login.html" onclick="logout()" class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 transition-colors hover:bg-red-500/10 hover:text-red-400">
                <span class="material-symbols-outlined">logout</span>
                <span class="font-medium">ログアウト</span>
            </a>
        </div>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-black text-white">ポートフォリオ</h1>
                <button onclick="openModal()" class="flex items-center justify-center gap-2 rounded-lg bg-primary px-5 py-3 font-semibold text-white hover:bg-primary/90">
                    <span class="material-symbols-outlined">add</span><span>資産を追加</span>
                </button>
            </div>
            <div class="bg-[#16212e] rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="border-b border-white/10"><tr><th class="px-6 py-4 text-sm font-medium text-gray-400">資産名</th><th class="px-6 py-4 text-sm font-medium text-gray-400 text-right">評価額</th><th class="px-6 py-4 text-sm font-medium text-gray-400 text-right">評価損益</th><th class="px-6 py-4 text-sm font-medium text-gray-400 text-right">操作</th></tr></thead>
                        <tbody id="asset-list" class="divide-y divide-white/10"></tbody>
                        <tfoot class="border-t-2 border-white/10 bg-black/20"><tr class="font-bold text-white"><td class="px-6 py-4">合計</td><td id="total-current-value" class="px-6 py-4 text-right"></td><td id="total-gain-loss" class="px-6 py-4 text-right"></td><td></td></tr></tfoot>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="asset-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/70">
    <div class="w-full max-w-md rounded-xl border border-gray-700 bg-gray-800 p-6">
        <div class="flex items-center justify-between"><h2 id="modal-title" class="flex items-center gap-3 text-lg font-bold text-white"></h2><button onclick="closeModal()" class="text-gray-400 hover:text-white"><span class="material-symbols-outlined">close</span></button></div>
        <form id="asset-form" class="mt-4 grid grid-cols-1 gap-4">
            <input type="hidden" id="asset-id">
            <div><label for="asset-name" class="text-sm font-medium text-gray-400">資産名</label><input type="text" id="asset-name" required class="form-input mt-1 block w-full rounded-lg border-gray-700 bg-[#283039] text-white"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label for="asset-quantity" class="text-sm font-medium text-gray-400">保有数量</label><input type="number" step="any" id="asset-quantity" required class="form-input mt-1 block w-full rounded-lg border-gray-700 bg-[#283039] text-white"></div>
                <div><label for="asset-purchase-price" class="text-sm font-medium text-gray-400">取得単価</label><input type="number" step="any" id="asset-purchase-price" required class="form-input mt-1 block w-full rounded-lg border-gray-700 bg-[#283039] text-white"></div>
            </div>
            <div><label for="asset-current-price" class="text-sm font-medium text-gray-400">現在価格</label><input type="number" step="any" id="asset-current-price" required class="form-input mt-1 block w-full rounded-lg border-gray-700 bg-[#283039] text-white"></div>
            <button type="submit" class="mt-4 flex w-full items-center justify-center gap-2 rounded-lg bg-primary py-3 font-semibold text-white hover:bg-primary/90"><span class="material-symbols-outlined">save</span>保存する</button>
        </form>
    </div>
</div>

<script>
    const modal = document.getElementById('asset-modal');
    const form = document.getElementById('asset-form');

    document.addEventListener('DOMContentLoaded', fetchAssets);
    form.addEventListener('submit', handleFormSubmit);

    function openModal(asset = null) {
        form.reset();
        const modalTitle = document.getElementById('modal-title');
        if (asset) {
            modalTitle.innerHTML = `<span class="material-symbols-outlined">edit</span> 資産を編集`;
            document.getElementById('asset-id').value = asset.id;
            document.getElementById('asset-name').value = asset.name;
            document.getElementById('asset-quantity').value = asset.quantity;
            document.getElementById('asset-purchase-price').value = asset.purchasePrice;
            document.getElementById('asset-current-price').value = asset.currentPrice;
        } else {
            modalTitle.innerHTML = `<span class="material-symbols-outlined">add</span> 新しい資産を追加`;
            document.getElementById('asset-id').value = '';
        }
        modal.classList.remove('hidden'); modal.classList.add('flex');
    }

    function closeModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }

    async function handleFormSubmit(event) {
        event.preventDefault();
        const id = document.getElementById('asset-id').value;
        const assetData = {
            name: document.getElementById('asset-name').value,
            quantity: parseFloat(document.getElementById('asset-quantity').value),
            purchasePrice: parseFloat(document.getElementById('asset-purchase-price').value),
            currentPrice: parseFloat(document.getElementById('asset-current-price').value),
            assetType: 'STOCK'
        };
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/portfolio/assets/${id}` : '/api/portfolio/assets';
        await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(assetData) });
        closeModal();
        fetchAssets();
    }

    async function fetchAssets() {
        const response = await fetch('/api/portfolio/assets');
        const assets = await response.json();
        const list = document.getElementById('asset-list');
        list.innerHTML = '';
        if (assets.length === 0) {
            list.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-400">まだ資産がありません。「資産を追加」から最初の資産を登録しましょう。</td></tr>`;
        }
        let totalPurchaseValue = 0, totalCurrentValue = 0;

        assets.forEach(asset => {
            const currentValue = asset.quantity * asset.currentPrice;
            const gainLoss = currentValue - (asset.quantity * asset.purchasePrice);
            const gainLossClass = gainLoss >= 0 ? 'text-green-400' : 'text-red-400';
            totalCurrentValue += currentValue;
            totalPurchaseValue += (asset.quantity * asset.purchasePrice);
            const item = document.createElement('tr');
            item.innerHTML = `
                <td class="px-6 py-4 text-sm font-medium text-white">${asset.name}</td>
                <td class="px-6 py-4 text-right text-sm text-gray-300">¥${Math.round(currentValue).toLocaleString()}</td>
                <td class="px-6 py-4 text-right text-sm font-medium ${gainLossClass}">${gainLoss >= 0 ? '+' : ''}¥${Math.round(gainLoss).toLocaleString()}</td>
                <td class="px-6 py-4 text-right text-sm">
                    <button onclick='openModal(${JSON.stringify(asset)})' class="rounded-lg border border-gray-700 p-2 text-gray-400 transition-colors hover:border-primary hover:text-primary"><span class="material-symbols-outlined">edit</span></button>
                    <button onclick="deleteAsset(${asset.id})" class="ml-2 rounded-lg border border-gray-700 p-2 text-gray-400 transition-colors hover:border-red-500 hover:text-red-500"><span class="material-symbols-outlined">delete</span></button>
                </td>`;
            list.appendChild(item);
        });

        const totalGainLoss = totalCurrentValue - totalPurchaseValue;
        document.getElementById('total-current-value').textContent = `¥${Math.round(totalCurrentValue).toLocaleString()}`;
        document.getElementById('total-gain-loss').className = `px-6 py-4 text-right ${totalGainLoss >= 0 ? 'text-green-400' : 'text-red-400'}`;
        document.getElementById('total-gain-loss').textContent = `${totalGainLoss >= 0 ? '+' : ''}¥${Math.round(totalGainLoss).toLocaleString()}`;
    }

    async function deleteAsset(id) {
        if (confirm('この資産を本当に削除しますか？')) {
            await fetch(`/api/portfolio/assets/${id}`, { method: 'DELETE' });
            fetchAssets();
        }
    }
</script>
</body>
</html>

